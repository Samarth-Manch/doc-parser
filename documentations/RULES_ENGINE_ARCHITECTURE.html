<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Rules Engine Architecture - Document Parser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: rgba(255,255,255,0.03);
            --border-color: rgba(255,255,255,0.08);
            --text-primary: #eee;
            --text-secondary: #bbb;
            --text-muted: #888;
            --accent-cyan: #00d4ff;
            --accent-purple: #7c3aed;
            --accent-orange: #f59e0b;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-pink: #ec4899;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 0;
            margin-bottom: 40px;
            background: linear-gradient(180deg, rgba(0,212,255,0.1) 0%, transparent 100%);
            border-radius: 20px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple), var(--accent-orange), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        /* Table of Contents */
        .toc {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
        }

        .toc h2 {
            color: var(--accent-cyan);
            margin-bottom: 20px;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .toc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .toc-item:hover {
            background: rgba(0,212,255,0.1);
            color: var(--accent-cyan);
            transform: translateX(5px);
        }

        .toc-number {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Sections */
        .section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
        }

        .section h2 {
            color: var(--accent-cyan);
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0,212,255,0.2);
        }

        .section h2 .badge {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.5em;
            color: white;
        }

        .section h3 {
            color: var(--text-primary);
            margin: 30px 0 15px;
            font-size: 1.3em;
        }

        .section h4 {
            color: var(--accent-cyan);
            margin: 20px 0 10px;
            font-size: 1.1em;
        }

        .section p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            text-align: center;
            padding: 25px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.85em;
            margin-top: 8px;
        }

        /* Cards */
        .card {
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            padding: 25px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }

        .card.highlight-cyan { border-left: 4px solid var(--accent-cyan); }
        .card.highlight-purple { border-left: 4px solid var(--accent-purple); }
        .card.highlight-orange { border-left: 4px solid var(--accent-orange); }
        .card.highlight-green { border-left: 4px solid var(--accent-green); }
        .card.highlight-blue { border-left: 4px solid var(--accent-blue); }
        .card.highlight-red { border-left: 4px solid var(--accent-red); }
        .card.highlight-pink { border-left: 4px solid var(--accent-pink); }

        .card h4 {
            margin-top: 0;
        }

        .card ul {
            list-style: none;
            padding: 0;
        }

        .card li {
            padding: 8px 0;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .card li:last-child {
            border-bottom: none;
        }

        .card li::before {
            content: 'â†’';
            color: var(--accent-purple);
            margin-right: 10px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 800px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* Code Blocks */
        .code-block {
            background: #0d1117;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.5;
        }

        .code-block .keyword { color: #ff7b72; }
        .code-block .function { color: #d2a8ff; }
        .code-block .string { color: #a5d6ff; }
        .code-block .variable { color: #ffa657; }
        .code-block .comment { color: #8b949e; }
        .code-block .number { color: #79c0ff; }
        .code-block .highlight-src { background: rgba(59,130,246,0.3); padding: 2px 6px; border-radius: 4px; }
        .code-block .highlight-dest { background: rgba(34,197,94,0.3); padding: 2px 6px; border-radius: 4px; }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .data-table th, .data-table td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .data-table th {
            background: rgba(0,212,255,0.1);
            color: var(--accent-cyan);
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .data-table code {
            background: rgba(0,0,0,0.4);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
        }

        /* Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            display: inline-block;
        }

        .badge-cyan { background: rgba(0,212,255,0.2); color: var(--accent-cyan); }
        .badge-purple { background: rgba(124,58,237,0.2); color: var(--accent-purple); }
        .badge-orange { background: rgba(251,146,60,0.2); color: var(--accent-orange); }
        .badge-green { background: rgba(34,197,94,0.2); color: var(--accent-green); }
        .badge-blue { background: rgba(59,130,246,0.2); color: var(--accent-blue); }
        .badge-red { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .badge-pink { background: rgba(236,72,153,0.2); color: var(--accent-pink); }

        /* Flow Diagrams */
        .flow-container {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 30px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .flow-node {
            background: linear-gradient(145deg, rgba(0,212,255,0.15), rgba(124,58,237,0.1));
            border: 2px solid rgba(0,212,255,0.4);
            border-radius: 12px;
            padding: 18px 25px;
            text-align: center;
            min-width: 160px;
            position: relative;
            transition: all 0.3s ease;
        }

        .flow-node:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0,212,255,0.2);
        }

        .flow-node.input { border-color: var(--accent-green); background: linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05)); }
        .flow-node.process { border-color: var(--accent-blue); background: linear-gradient(145deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05)); }
        .flow-node.llm { border-color: var(--accent-orange); background: linear-gradient(145deg, rgba(251,146,60,0.2), rgba(251,146,60,0.05)); }
        .flow-node.output { border-color: var(--accent-purple); background: linear-gradient(145deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05)); }
        .flow-node.cache { border-color: var(--accent-cyan); background: linear-gradient(145deg, rgba(0,212,255,0.2), rgba(0,212,255,0.05)); }
        .flow-node.source { border-color: var(--accent-blue); background: linear-gradient(145deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05)); }
        .flow-node.dest { border-color: var(--accent-green); background: linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05)); }

        .flow-node h5 {
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .flow-node p {
            font-size: 0.75em;
            color: var(--text-muted);
            margin: 0;
        }

        .flow-node .node-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--accent-green);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.65em;
            font-weight: bold;
        }

        .flow-node .node-badge.llm-badge { background: var(--accent-orange); }

        .flow-arrow {
            font-size: 1.8em;
            color: var(--accent-cyan);
        }

        .flow-arrow-down {
            text-align: center;
            font-size: 2em;
            color: var(--accent-cyan);
            margin: 10px 0;
        }

        /* Hierarchical Tree */
        .tree-container {
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            margin: 20px 0;
        }

        .tree-level {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .tree-level .level-label {
            position: absolute;
            left: 0;
            background: linear-gradient(90deg, var(--accent-purple), transparent);
            padding: 5px 20px;
            border-radius: 0 20px 20px 0;
            font-size: 0.75em;
            font-weight: bold;
        }

        .tree-branches {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tree-node {
            background: linear-gradient(145deg, rgba(0,212,255,0.15), rgba(124,58,237,0.1));
            border: 2px solid rgba(0,212,255,0.4);
            border-radius: 12px;
            padding: 15px 25px;
            text-align: center;
            min-width: 150px;
        }

        .tree-node.expression { border-color: var(--accent-orange); background: linear-gradient(145deg, rgba(251,146,60,0.2), rgba(251,146,60,0.1)); }
        .tree-node.standard { border-color: var(--accent-green); background: linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1)); }
        .tree-node.action { border-color: var(--accent-purple); background: linear-gradient(145deg, rgba(168,85,247,0.2), rgba(168,85,247,0.1)); }
        .tree-node.source-type { border-color: var(--accent-pink); background: linear-gradient(145deg, rgba(236,72,153,0.2), rgba(236,72,153,0.1)); }
        .tree-node.final { border-color: var(--accent-green); background: linear-gradient(145deg, rgba(34,197,94,0.3), rgba(34,197,94,0.1)); }

        .tree-node h5 {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .tree-node p {
            font-size: 0.7em;
            color: var(--text-muted);
            margin: 0;
        }

        .tree-node .count {
            background: rgba(0,0,0,0.4);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.7em;
            margin-top: 8px;
            display: inline-block;
        }

        /* Callouts */
        .callout {
            background: linear-gradient(90deg, rgba(59,130,246,0.1), rgba(59,130,246,0.02));
            border-left: 4px solid var(--accent-blue);
            padding: 20px 25px;
            border-radius: 0 12px 12px 0;
            margin: 20px 0;
        }

        .callout.success {
            background: linear-gradient(90deg, rgba(34,197,94,0.1), rgba(34,197,94,0.02));
            border-left-color: var(--accent-green);
        }

        .callout.warning {
            background: linear-gradient(90deg, rgba(251,146,60,0.1), rgba(251,146,60,0.02));
            border-left-color: var(--accent-orange);
        }

        .callout.danger {
            background: linear-gradient(90deg, rgba(239,68,68,0.1), rgba(239,68,68,0.02));
            border-left-color: var(--accent-red);
        }

        .callout.info {
            background: linear-gradient(90deg, rgba(168,85,247,0.1), rgba(168,85,247,0.02));
            border-left-color: var(--accent-purple);
        }

        .callout h4 {
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .callout p, .callout ul {
            margin: 0;
        }

        /* Pattern Boxes */
        .pattern-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 18px;
            margin: 12px 0;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .pattern-box h5 {
            color: var(--accent-orange);
            font-size: 0.85em;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .pattern-box .example {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85em;
            color: #ccc;
            margin-top: 10px;
        }

        .pattern-box .extracted {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pattern-box .extracted span {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .pattern-box .extracted .src { background: rgba(59,130,246,0.3); color: #60a5fa; }
        .pattern-box .extracted .dest { background: rgba(34,197,94,0.3); color: #4ade80; }
        .pattern-box .extracted .cond { background: rgba(251,146,60,0.3); color: #fb923c; }

        /* Keyword Tags */
        .keyword-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .keyword-tag {
            background: rgba(124,58,237,0.2);
            color: #c4b5fd;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-family: monospace;
        }

        .keyword-tag.source { background: rgba(59,130,246,0.2); color: #93c5fd; }
        .keyword-tag.dest { background: rgba(34,197,94,0.2); color: #86efac; }

        /* Algorithm Box */
        .algorithm-box {
            background: #0d1117;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .algorithm-box h4 {
            color: var(--accent-cyan);
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 1em;
        }

        .algorithm-line {
            padding: 4px 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .algorithm-line .indent-1 { margin-left: 25px; }
        .algorithm-line .indent-2 { margin-left: 50px; }
        .algorithm-line .indent-3 { margin-left: 75px; }
        .algorithm-line .indent-4 { margin-left: 100px; }

        /* Priority Flow */
        .priority-flow {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .priority-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .priority-step.p1 {
            background: linear-gradient(90deg, rgba(34,197,94,0.3), rgba(34,197,94,0.1));
            border: 1px solid rgba(34,197,94,0.5);
        }

        .priority-step.p2 {
            background: linear-gradient(90deg, rgba(59,130,246,0.3), rgba(59,130,246,0.1));
            border: 1px solid rgba(59,130,246,0.5);
        }

        .priority-step.p3 {
            background: linear-gradient(90deg, rgba(251,146,60,0.3), rgba(251,146,60,0.1));
            border: 1px solid rgba(251,146,60,0.5);
        }

        .priority-arrow {
            color: var(--text-muted);
            font-size: 1.2em;
        }

        /* Search Space Visualization */
        .search-space {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 25px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .search-box {
            text-align: center;
            padding: 20px 25px;
            border-radius: 12px;
            min-width: 130px;
        }

        .search-box.full { background: linear-gradient(145deg, rgba(239,68,68,0.3), rgba(239,68,68,0.1)); border: 2px solid rgba(239,68,68,0.5); }
        .search-box.reduced { background: linear-gradient(145deg, rgba(251,146,60,0.3), rgba(251,146,60,0.1)); border: 2px solid rgba(251,146,60,0.5); }
        .search-box.narrow { background: linear-gradient(145deg, rgba(34,197,94,0.3), rgba(34,197,94,0.1)); border: 2px solid rgba(34,197,94,0.5); }

        .search-box .number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .search-box.full .number { color: var(--accent-red); }
        .search-box.reduced .number { color: var(--accent-orange); }
        .search-box.narrow .number { color: var(--accent-green); }

        .search-box .label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .reduction-arrow {
            font-size: 2em;
            color: var(--accent-cyan);
        }

        /* JSON Output */
        .json-output {
            background: #0d1117;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-x: auto;
        }

        .json-output pre {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.85em;
            line-height: 1.6;
        }

        /* Function Reference Grid */
        .func-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .func-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .func-item code {
            color: #d2a8ff;
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
        }

        .func-item p {
            color: var(--text-muted);
            font-size: 0.8em;
            margin-top: 8px;
            margin-bottom: 0;
        }

        /* Comparison Container */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 25px 0;
        }

        @media (max-width: 900px) {
            .comparison-container { grid-template-columns: 1fr; }
        }

        .comparison-box {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid var(--border-color);
        }

        .comparison-box.expression {
            border-color: rgba(251,146,60,0.4);
        }

        .comparison-box.standard {
            border-color: rgba(34,197,94,0.4);
        }

        .comparison-box h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-box.expression h3 { color: var(--accent-orange); }
        .comparison-box.standard h3 { color: var(--accent-green); }

        /* Pipeline Stages */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .pipeline-stage {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid var(--accent-cyan);
        }

        .pipeline-stage.stage-1 { border-left-color: var(--accent-green); }
        .pipeline-stage.stage-2 { border-left-color: var(--accent-blue); }
        .pipeline-stage.stage-3 { border-left-color: var(--accent-purple); }
        .pipeline-stage.stage-4 { border-left-color: var(--accent-orange); }
        .pipeline-stage.stage-5 { border-left-color: var(--accent-pink); }
        .pipeline-stage.stage-6 { border-left-color: var(--accent-red); }

        .pipeline-stage h4 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 0;
        }

        .stage-number {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        footer p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>Complete Rules Engine Architecture</h1>
            <p class="subtitle">Comprehensive Guide to Rules Extraction with Deterministic-First Approach</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value">2</div>
                    <div class="label">Rule Categories</div>
                </div>
                <div class="stat-card">
                    <div class="value">17</div>
                    <div class="label">Rule Clusters</div>
                </div>
                <div class="stat-card">
                    <div class="value">182</div>
                    <div class="label">Predefined Rules</div>
                </div>
                <div class="stat-card">
                    <div class="value">6</div>
                    <div class="label">Processing Steps</div>
                </div>
                <div class="stat-card">
                    <div class="value">~85%</div>
                    <div class="label">Deterministic</div>
                </div>
                <div class="stat-card">
                    <div class="value">~$0.03</div>
                    <div class="label">Per Document</div>
                </div>
            </div>
        </header>

        <!-- Table of Contents -->
        <nav class="toc">
            <h2>ðŸ“‘ Table of Contents</h2>
            <div class="toc-grid">
                <a href="#overview" class="toc-item">
                    <span class="toc-number">1</span>
                    <span>System Overview & Philosophy</span>
                </a>
                <a href="#architecture" class="toc-item">
                    <span class="toc-number">2</span>
                    <span>High-Level Architecture</span>
                </a>
                <a href="#rule-types" class="toc-item">
                    <span class="toc-number">3</span>
                    <span>Two Types of Rules</span>
                </a>
                <a href="#expression-rules" class="toc-item">
                    <span class="toc-number">4</span>
                    <span>Expression Rules Deep Dive</span>
                </a>
                <a href="#standard-rules" class="toc-item">
                    <span class="toc-number">5</span>
                    <span>Standard Rules & Classification</span>
                </a>
                <a href="#source-detection" class="toc-item">
                    <span class="toc-number">6</span>
                    <span>Source Field Detection</span>
                </a>
                <a href="#destination-detection" class="toc-item">
                    <span class="toc-number">7</span>
                    <span>Destination Field Detection</span>
                </a>
                <a href="#pipeline" class="toc-item">
                    <span class="toc-number">8</span>
                    <span>6-Step Processing Pipeline</span>
                </a>
                <a href="#anti-hallucination" class="toc-item">
                    <span class="toc-number">9</span>
                    <span>Anti-Hallucination Strategies</span>
                </a>
                <a href="#cost-optimization" class="toc-item">
                    <span class="toc-number">10</span>
                    <span>Cost Optimization</span>
                </a>
                <a href="#output-schema" class="toc-item">
                    <span class="toc-number">11</span>
                    <span>Output JSON Schema</span>
                </a>
                <a href="#implementation" class="toc-item">
                    <span class="toc-number">12</span>
                    <span>Implementation Modules</span>
                </a>
            </div>
        </nav>

        <!-- Section 1: Overview -->
        <section id="overview" class="section">
            <h2><span class="badge">SECTION 1</span> System Overview & Philosophy</h2>

            <h3>Problem Statement</h3>
            <p>Convert natural language field logic from BUD (Business Use Documents) into structured, executable rules that can control form field behavior dynamically.</p>

            <div class="grid-2">
                <div class="card highlight-blue">
                    <h4>ðŸ“¥ Input</h4>
                    <ul>
                        <li>Word documents (.docx) with field tables</li>
                        <li>Logic column containing natural language rules</li>
                        <li>Example: "Make visible if GST Option is Yes otherwise invisible"</li>
                    </ul>
                </div>
                <div class="card highlight-green">
                    <h4>ðŸ“¤ Output</h4>
                    <ul>
                        <li>Structured JSON with executable rules</li>
                        <li>Expression syntax (expr-eval)</li>
                        <li>Example: <code>mvi(vo("__gst_option__")=='Yes', "__gstin__")</code></li>
                    </ul>
                </div>
            </div>

            <h3>Deterministic-First Philosophy</h3>
            <div class="priority-flow">
                <div class="priority-step p1">
                    <strong>Priority 1:</strong> Regex Pattern Matching
                </div>
                <span class="priority-arrow">â†’</span>
                <div class="priority-step p2">
                    <strong>Priority 2:</strong> Rule Schema Lookup
                </div>
                <span class="priority-arrow">â†’</span>
                <div class="priority-step p3">
                    <strong>Priority 3:</strong> Grounded LLM Extraction
                </div>
            </div>

            <div class="grid-2">
                <div class="card highlight-green">
                    <h4>âœ… Why Deterministic First?</h4>
                    <ul>
                        <li><strong>Zero hallucination:</strong> Regex can't invent fields</li>
                        <li><strong>Zero cost:</strong> No API calls for pattern matches</li>
                        <li><strong>Predictable:</strong> Same input always gives same output</li>
                        <li><strong>Debuggable:</strong> Easy to trace why a field was identified</li>
                        <li><strong>Fast:</strong> Milliseconds vs seconds for LLM</li>
                    </ul>
                </div>
                <div class="card highlight-orange">
                    <h4>ðŸ”„ When LLM is Used</h4>
                    <ul>
                        <li>Complex multi-field conditions</li>
                        <li>Ambiguous field references</li>
                        <li>Implicit source/destination relationships</li>
                        <li>Non-standard phrasing</li>
                        <li>Always with grounded prompt (field registry)</li>
                    </ul>
                </div>
            </div>

            <div class="callout success">
                <h4>âœ… Expected Distribution</h4>
                <p><strong>~85% Deterministic:</strong> Pattern matching handles most standard logic phrases<br>
                <strong>~15% LLM:</strong> Complex cases with grounded prompts for zero hallucination risk</p>
            </div>
        </section>

        <!-- Section 2: High-Level Architecture -->
        <section id="architecture" class="section">
            <h2><span class="badge">SECTION 2</span> High-Level Architecture</h2>

            <div class="flow-container">
                <!-- Row 1: Input -->
                <div class="flow-row">
                    <div class="flow-node input">
                        <h5>Word Document</h5>
                        <p>BUD Templates (.docx)</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node process">
                        <span class="node-badge">No LLM</span>
                        <h5>Document Parser</h5>
                        <p>Extract fields, logic, tables</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node cache">
                        <span class="node-badge">No LLM</span>
                        <h5>Field Registry</h5>
                        <p>Name â†’ Variable mapping</p>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“</div>

                <!-- Row 2: Classification -->
                <div class="flow-row">
                    <div class="flow-node process">
                        <span class="node-badge">No LLM</span>
                        <h5>Rule Classifier</h5>
                        <p>Pattern-based classification</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node" style="display: flex; gap: 30px; min-width: 400px; justify-content: center;">
                        <div style="text-align: center;">
                            <h5 style="color: var(--accent-orange);">Expression Rules</h5>
                            <p>Visibility, Mandatory, Copy</p>
                        </div>
                        <div style="width: 2px; background: rgba(255,255,255,0.2);"></div>
                        <div style="text-align: center;">
                            <h5 style="color: var(--accent-green);">Standard Rules</h5>
                            <p>OCR, Validation, Verify</p>
                        </div>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“</div>

                <!-- Row 3: Processing -->
                <div class="flow-row">
                    <div class="flow-node cache">
                        <span class="node-badge">No LLM</span>
                        <h5>Pattern Cache</h5>
                        <p>Template matching</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node llm">
                        <span class="node-badge llm-badge">GPT-4o-mini</span>
                        <h5>Intent Extractor</h5>
                        <p>Grounded LLM extraction</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node process">
                        <span class="node-badge">No LLM</span>
                        <h5>Resolver</h5>
                        <p>Variable name resolution</p>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“</div>

                <!-- Row 4: Output -->
                <div class="flow-row">
                    <div class="flow-node process">
                        <span class="node-badge">No LLM</span>
                        <h5>Validator</h5>
                        <p>Syntax & function check</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node process">
                        <span class="node-badge">No LLM</span>
                        <h5>Assembler</h5>
                        <p>Build expr-eval syntax</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node output">
                        <h5>Rules JSON</h5>
                        <p>Final structured output</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Two Types of Rules -->
        <section id="rule-types" class="section">
            <h2><span class="badge">SECTION 3</span> Two Types of Rules</h2>

            <div class="flow-container">
                <div class="flow-row">
                    <div class="flow-node source">
                        <h5>SOURCE FIELD</h5>
                        <p>Field whose value is checked<br>or data is copied FROM</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node">
                        <h5>CONDITION/ACTION</h5>
                        <p>Rule logic that connects<br>source to destination</p>
                    </div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-node dest">
                        <h5>DESTINATION FIELD</h5>
                        <p>Field that is affected<br>(shown/hidden/populated)</p>
                    </div>
                </div>
            </div>

            <div class="comparison-container">
                <div class="comparison-box expression">
                    <h3>ðŸ”¶ Expression Rules (EXECUTE Action)</h3>
                    <p>Dynamic field behavior using expr-eval JavaScript library. Control visibility, mandatory status, enable/disable, and data copying based on conditions.</p>

                    <div class="code-block">
<span class="comment">// Natural Language Input:</span>
"Make visible and Mandatory if GST Option is Yes otherwise invisible"

<span class="comment">// Generated Expression:</span>
<span class="function">mvi</span>(vo(<span class="string">"__gst_option__"</span>)==<span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">mm</span>(vo(<span class="string">"__gst_option__"</span>)==<span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">minvi</span>(vo(<span class="string">"__gst_option__"</span>)!=<span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">mnm</span>(vo(<span class="string">"__gst_option__"</span>)!=<span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
                    </div>

                    <table class="data-table">
                        <tr>
                            <td><strong>Source</strong></td>
                            <td>Field in condition (e.g., <code>vo(__gst_option__)</code>)</td>
                        </tr>
                        <tr>
                            <td><strong>Destination</strong></td>
                            <td>Fields being shown/hidden/enabled</td>
                        </tr>
                        <tr>
                            <td><strong>Action</strong></td>
                            <td>EXECUTE (always for expression rules)</td>
                        </tr>
                    </table>
                </div>

                <div class="comparison-box standard">
                    <h3>ðŸŸ¢ Standard/Predefined Rules</h3>
                    <p>Pre-configured rules from Rule-Schemas.json (182 rules). Include OCR extraction, API validation, verification, and data copy operations.</p>

                    <div class="code-block">
<span class="comment">// Natural Language Input:</span>
"Apply PAN OCR on uploaded PAN card image"

<span class="comment">// Matched Rule from Schema:</span>
{
  <span class="string">"name"</span>: <span class="string">"PAN OCR"</span>,
  <span class="string">"action"</span>: <span class="string">"OCR"</span>,
  <span class="string">"source"</span>: <span class="string">"PAN_IMAGE"</span>,
  <span class="string">"destinationFields"</span>: [<span class="string">"panNo"</span>, <span class="string">"name"</span>, <span class="string">"fatherName"</span>, <span class="string">"dob"</span>]
}
                    </div>

                    <table class="data-table">
                        <tr>
                            <td><strong>Source</strong></td>
                            <td>Document/image upload field</td>
                        </tr>
                        <tr>
                            <td><strong>Destination</strong></td>
                            <td>Fields receiving extracted/validated data</td>
                        </tr>
                        <tr>
                            <td><strong>Action</strong></td>
                            <td>OCR, VERIFY, VALIDATION, COPY_TO, etc.</td>
                        </tr>
                    </table>
                </div>
            </div>
        </section>

        <!-- Section 4: Expression Rules Deep Dive -->
        <section id="expression-rules" class="section">
            <h2><span class="badge">SECTION 4</span> Expression Rules Deep Dive</h2>

            <h3>Available Expression Functions</h3>

            <h4>Visibility Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>makeVisible(condition, ...destIds)</code>
                    <p>Alias: <code>mvi</code> â€” Show fields when condition is true</p>
                </div>
                <div class="func-item">
                    <code>makeInvisible(condition, ...destIds)</code>
                    <p>Alias: <code>minvi</code> â€” Hide fields when condition is true</p>
                </div>
                <div class="func-item">
                    <code>sessionBasedMakeVisible(cond, param, ...destIds)</code>
                    <p>Alias: <code>sbmvi</code> â€” Show based on session parameter</p>
                </div>
                <div class="func-item">
                    <code>sessionBasedMakeInvisible(cond, param, ...destIds)</code>
                    <p>Alias: <code>sbminvi</code> â€” Hide based on session parameter</p>
                </div>
            </div>

            <h4>Mandatory Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>makeMandatory(condition, ...destIds)</code>
                    <p>Alias: <code>mm</code> â€” Make fields required when condition is true</p>
                </div>
                <div class="func-item">
                    <code>makeNonMandatory(condition, ...destIds)</code>
                    <p>Alias: <code>mnm</code> â€” Make fields optional when condition is true</p>
                </div>
            </div>

            <h4>Enable/Disable Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>enable(condition, ...destIds)</code>
                    <p>Alias: <code>en</code> â€” Enable (editable) fields when condition is true</p>
                </div>
                <div class="func-item">
                    <code>disable(condition, ...destIds)</code>
                    <p>Alias: <code>dis</code> â€” Disable (read-only) fields when condition is true</p>
                </div>
            </div>

            <h4>Data Manipulation Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>copyToFillData(condition, srcValue, ...destIds)</code>
                    <p>Alias: <code>ctfd</code> â€” Copy value to destination fields</p>
                </div>
                <div class="func-item">
                    <code>clearField(condition, ...destIds)</code>
                    <p>Alias: <code>cf</code> â€” Clear field values when condition is true</p>
                </div>
                <div class="func-item">
                    <code>executeRuleById(condition, ...formFillMetadataIds)</code>
                    <p>Alias: <code>erbyid</code> â€” Execute rules of another field</p>
                </div>
            </div>

            <h4>Error Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>addError(condition, message, ...destIds)</code>
                    <p>Alias: <code>adderr</code> â€” Add error message to fields</p>
                </div>
                <div class="func-item">
                    <code>removeError(condition, ...destIds)</code>
                    <p>Alias: <code>remerr</code> â€” Remove error message from fields</p>
                </div>
            </div>

            <h4>Helper Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>valOf(id)</code>
                    <p>Alias: <code>vo</code> â€” Get field value by variable name</p>
                </div>
                <div class="func-item">
                    <code>getElementById(id)</code>
                    <p>Alias: <code>elbyid</code> â€” Get element reference by ID</p>
                </div>
                <div class="func-item">
                    <code>partyType()</code>
                    <p>Alias: <code>pt</code> â€” Returns "FP", "SP", or undefined</p>
                </div>
                <div class="func-item">
                    <code>memberType()</code>
                    <p>Alias: <code>mt</code> â€” Returns CREATED_BY, CREATED_FOR, APPROVER, GENERIC_PARTY</p>
                </div>
                <div class="func-item">
                    <code>validationStatusOf(id)</code>
                    <p>Alias: <code>vso</code> â€” Returns INIT, SUCCESS, FAIL, PENDING, etc.</p>
                </div>
                <div class="func-item">
                    <code>formTag(id)</code>
                    <p>Alias: <code>ft</code> â€” Get form field name</p>
                </div>
            </div>

            <h4>String Functions</h4>
            <div class="func-grid">
                <div class="func-item">
                    <code>concat(values...)</code>
                    <p>Concatenate multiple values</p>
                </div>
                <div class="func-item">
                    <code>concatWithDelimiter(delimiter, values...)</code>
                    <p>Alias: <code>cwd</code> â€” Concatenate with delimiter, ignores empty values</p>
                </div>
                <div class="func-item">
                    <code>toLowerCase(value)</code>
                    <p>Alias: <code>tolc</code> â€” Convert to lowercase</p>
                </div>
                <div class="func-item">
                    <code>toUpperCase(value)</code>
                    <p>Alias: <code>touc</code> â€” Convert to uppercase</p>
                </div>
                <div class="func-item">
                    <code>contains(sequenceToSearch, value)</code>
                    <p>Alias: <code>cntns</code> â€” Check if string contains value</p>
                </div>
                <div class="func-item">
                    <code>regexTest(value, regex)</code>
                    <p>Alias: <code>rgxtst</code> â€” Test regex pattern against value</p>
                </div>
                <div class="func-item">
                    <code>replaceRange(str, start, end, subst)</code>
                    <p>Alias: <code>rplrng</code> â€” Replace range of characters</p>
                </div>
            </div>

            <h3>Expression Syntax Reference</h3>
            <div class="code-block">
<span class="comment">// Basic condition</span>
vo(<span class="string">"__field_var__"</span>) == <span class="string">'value'</span>

<span class="comment">// Multiple conditions with AND</span>
vo(<span class="string">"__field1__"</span>) == <span class="string">'Yes'</span> <span class="keyword">and</span> vo(<span class="string">"__field2__"</span>) == <span class="string">'Active'</span>

<span class="comment">// Multiple conditions with OR</span>
vo(<span class="string">"__field1__"</span>) == <span class="string">'Yes'</span> <span class="keyword">or</span> vo(<span class="string">"__field2__"</span>) == <span class="string">'Yes'</span>

<span class="comment">// Not equal</span>
vo(<span class="string">"__field__"</span>) != <span class="string">'No'</span>

<span class="comment">// Comparison operators</span>
vo(<span class="string">"__amount__"</span>) > <span class="number">1000</span>
vo(<span class="string">"__age__"</span>) >= <span class="number">18</span>

<span class="comment">// Complete visibility + mandatory example</span>
<span class="function">mvi</span>(vo(<span class="string">"__gst_option__"</span>) == <span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">mm</span>(vo(<span class="string">"__gst_option__"</span>) == <span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">minvi</span>(vo(<span class="string">"__gst_option__"</span>) != <span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);
<span class="function">mnm</span>(vo(<span class="string">"__gst_option__"</span>) != <span class="string">'Yes'</span>, <span class="string">"__gstin__"</span>);

<span class="comment">// Disable field (always read-only)</span>
<span class="function">dis</span>(<span class="keyword">true</span>, <span class="string">"__transaction_id__"</span>);

<span class="comment">// Copy value conditionally</span>
<span class="function">ctfd</span>(vo(<span class="string">"__condition__"</span>) == <span class="string">'Yes'</span>, vo(<span class="string">"__source__"</span>), <span class="string">"__dest__"</span>);

<span class="comment">// Clear field conditionally</span>
<span class="function">cf</span>(vo(<span class="string">"__condition__"</span>) == <span class="string">'No'</span>, <span class="string">"__field_to_clear__"</span>);

<span class="comment">// Member type based visibility (Approver only)</span>
<span class="function">mvi</span>(<span class="function">mt</span>() == <span class="string">'APPROVER'</span>, <span class="string">"__approval_field__"</span>);
            </div>
        </section>

        <!-- Section 5: Standard Rules & Classification -->
        <section id="standard-rules" class="section">
            <h2><span class="badge">SECTION 5</span> Standard Rules & Hierarchical Classification</h2>

            <h3>Rule Actions Distribution (182 Total Rules)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Action Type</th>
                        <th>Count</th>
                        <th>Description</th>
                        <th>Example Rules</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-purple">VERIFY</span></td>
                        <td>23</td>
                        <td>External verification via API</td>
                        <td>PAN to CIN, Section 206AB, GSTIN Verification</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-blue">COPY_TO</span></td>
                        <td>20</td>
                        <td>Copy data between fields/attributes</td>
                        <td>Copy to Transaction Attr1-8, Copy CreatedBy Details</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-green">OCR</span></td>
                        <td>19</td>
                        <td>Extract text from images/documents</td>
                        <td>PAN OCR, Aadhaar OCR, GSTIN OCR, Passport OCR</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-orange">VALIDATION</span></td>
                        <td>11</td>
                        <td>Validate data against rules</td>
                        <td>Compare If Same, Calculate Liability</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-purple">COPY_TO_ATTR</span></td>
                        <td>16</td>
                        <td>Copy to transaction/party attributes</td>
                        <td>Copy To Attr1-8, Internal Attr1-4, GenericParty fields</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-pink">FIELD_STATE</span></td>
                        <td>12</td>
                        <td>Visibility, mandatory, enable/disable</td>
                        <td>Make Visible, Make Mandatory, Session-Based variants</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-cyan">DATE_TIME</span></td>
                        <td>10</td>
                        <td>Date/time operations</td>
                        <td>Set Date, Set Age From Date, Derive FY, Quarter</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-blue">DOCUMENT_MGMT</span></td>
                        <td>9</td>
                        <td>Document management operations</td>
                        <td>Delete Document, Classify, Upload Mandatory</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-orange">COMPARISON</span></td>
                        <td>8</td>
                        <td>Field comparison and duplicate check</td>
                        <td>Compare Name, Contains Text, Duplicate Check</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-green">GEOLOCATION</span></td>
                        <td>7</td>
                        <td>GPS and location services</td>
                        <td>Get Geolocation, Get Distance, Out Of Polygon</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-purple">DATA_TRANSFORM</span></td>
                        <td>6</td>
                        <td>Data transformation</td>
                        <td>Convert To Upper/Lower, Concatenate, Clear Field</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-blue">EXTERNAL_DATA</span></td>
                        <td>6</td>
                        <td>External data lookup</td>
                        <td>Lookup, EDV Dropdown, Fetch Related Txns</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-orange">OTP_AUTH</span></td>
                        <td>5</td>
                        <td>OTP and authentication</td>
                        <td>Send OTP, Validate OTP, Verify Liveness</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-pink">TXN_MGMT</span></td>
                        <td>5</td>
                        <td>Transaction workflow</td>
                        <td>Insert Into Table, Reassign Created For</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-green">IDENTITY</span></td>
                        <td>4</td>
                        <td>Biometric/identity verification</td>
                        <td>Face Compare, Video KYC, Name Match</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-cyan">FORM_GEN</span></td>
                        <td>4</td>
                        <td>Dynamic form generation</td>
                        <td>Generate Table From EDV/Staging/Transaction</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-red">SPECIALIZED</span></td>
                        <td>12</td>
                        <td>Domain-specific operations</td>
                        <td>Execute, Count, Sentiment, Speech To Text, eStamp</td>
                    </tr>
                </tbody>
            </table>

            <h3>4-Level Hierarchical Classification</h3>
            <p>To reduce search space and minimize hallucination, use hierarchical classification:</p>

            <div class="tree-container">
                <!-- Level 0: Input -->
                <div class="tree-level">
                    <span class="level-label">INPUT</span>
                    <div class="tree-node">
                        <h5>Natural Language Logic</h5>
                        <p>Field rules/logic text</p>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“</div>

                <!-- Level 1: Expression vs Standard -->
                <div class="tree-level">
                    <span class="level-label">LEVEL 1</span>
                    <div class="tree-branches">
                        <div class="tree-node expression">
                            <h5>Expression Rules</h5>
                            <p>Dynamic field behavior</p>
                            <span class="count">~70% of rules</span>
                        </div>
                        <div class="tree-node standard">
                            <h5>Standard Rules</h5>
                            <p>Predefined schemas</p>
                            <span class="count">182 rules total</span>
                        </div>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“ (Standard Rules Path)</div>

                <!-- Level 2: Action Type Clusters (17 total) -->
                <div class="tree-level">
                    <span class="level-label">LEVEL 2</span>
                    <div class="tree-branches">
                        <div class="tree-node action">
                            <h5>VERIFY</h5>
                            <p>API verification</p>
                            <span class="count">23 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>COPY_TO</h5>
                            <p>Copy operations</p>
                            <span class="count">20 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>OCR</h5>
                            <p>Text extraction</p>
                            <span class="count">19 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>COPY_TO_ATTR</h5>
                            <p>Transaction attrs</p>
                            <span class="count">16 rules</span>
                        </div>
                    </div>
                </div>
                <div class="tree-level">
                    <div class="tree-branches">
                        <div class="tree-node action">
                            <h5>FIELD_STATE</h5>
                            <p>Visibility/Enable</p>
                            <span class="count">12 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>VALIDATION</h5>
                            <p>Data validation</p>
                            <span class="count">11 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>DATE_TIME</h5>
                            <p>Date operations</p>
                            <span class="count">10 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>DOCUMENT</h5>
                            <p>Doc management</p>
                            <span class="count">9 rules</span>
                        </div>
                    </div>
                </div>
                <div class="tree-level">
                    <div class="tree-branches">
                        <div class="tree-node action">
                            <h5>COMPARISON</h5>
                            <p>Field compare</p>
                            <span class="count">8 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>GEOLOCATION</h5>
                            <p>GPS/Location</p>
                            <span class="count">7 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>DATA_TRANSFORM</h5>
                            <p>Transformations</p>
                            <span class="count">6 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>EXTERNAL_DATA</h5>
                            <p>Lookup/Fetch</p>
                            <span class="count">6 rules</span>
                        </div>
                    </div>
                </div>
                <div class="tree-level">
                    <div class="tree-branches">
                        <div class="tree-node action">
                            <h5>OTP_AUTH</h5>
                            <p>OTP/Auth</p>
                            <span class="count">5 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>TXN_MGMT</h5>
                            <p>Transaction</p>
                            <span class="count">5 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>IDENTITY</h5>
                            <p>Biometric/KYC</p>
                            <span class="count">4 rules</span>
                        </div>
                        <div class="tree-node action">
                            <h5>FORM_GEN</h5>
                            <p>Form generation</p>
                            <span class="count">4 rules</span>
                        </div>
                        <div class="tree-node action" style="opacity: 0.8;">
                            <h5>SPECIALIZED</h5>
                            <p>Domain-specific</p>
                            <span class="count">12 rules</span>
                        </div>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“ (OCR Path Example)</div>

                <!-- Level 3: Source Type -->
                <div class="tree-level">
                    <span class="level-label">LEVEL 3</span>
                    <div class="tree-branches">
                        <div class="tree-node source-type">
                            <h5>PAN_IMAGE</h5>
                            <p>PAN Card OCR</p>
                            <span class="count">1 rule</span>
                        </div>
                        <div class="tree-node source-type">
                            <h5>AADHAR_IMAGE</h5>
                            <p>Aadhaar Front OCR</p>
                            <span class="count">1 rule</span>
                        </div>
                        <div class="tree-node source-type">
                            <h5>GSTIN_IMAGE</h5>
                            <p>GST Certificate OCR</p>
                            <span class="count">1 rule</span>
                        </div>
                        <div class="tree-node source-type">
                            <h5>PASSPORT_*</h5>
                            <p>Passport OCR</p>
                            <span class="count">2 rules</span>
                        </div>
                        <div class="tree-node source-type" style="opacity: 0.8;">
                            <h5>+ 14 more</h5>
                            <p>DL, Cheque, MSME...</p>
                            <span class="count">14 rules</span>
                        </div>
                    </div>
                </div>

                <div class="flow-arrow-down">â†“</div>

                <!-- Level 4: Final Match -->
                <div class="tree-level">
                    <span class="level-label">LEVEL 4</span>
                    <div class="tree-node final">
                        <h5>Matched Rule</h5>
                        <p>Exact rule from schema</p>
                        <span class="count">1 rule</span>
                    </div>
                </div>
            </div>

            <h3>Search Space Reduction</h3>
            <div class="search-space">
                <div class="search-box full">
                    <div class="number">182</div>
                    <div class="label">All Rules</div>
                </div>
                <span class="reduction-arrow">â†’</span>
                <div class="search-box reduced">
                    <div class="number">19</div>
                    <div class="label">OCR Action</div>
                </div>
                <span class="reduction-arrow">â†’</span>
                <div class="search-box narrow">
                    <div class="number">1-2</div>
                    <div class="label">Source Type</div>
                </div>
                <span class="reduction-arrow">â†’</span>
                <div class="search-box narrow">
                    <div class="number">1</div>
                    <div class="label">Final Match</div>
                </div>
            </div>

            <div class="callout success">
                <h4>âœ… 95% Search Space Reduction</h4>
                <p>By using hierarchical classification, we reduce the search space from 182 rules to just 1-2 candidates before any LLM call. This dramatically reduces hallucination risk and API costs.</p>
            </div>

            <h3>OCR Rules - Source and Destination Fields</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Source Type</th>
                        <th>Rule Name</th>
                        <th>Destination Fields</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>PAN_IMAGE</code></td>
                        <td>PAN OCR</td>
                        <td>panNo, name, fatherName, dob</td>
                    </tr>
                    <tr>
                        <td><code>AADHAR_IMAGE</code></td>
                        <td>Aadhaar Front OCR</td>
                        <td>aadharNumberMasked, name, gender, dob, address</td>
                    </tr>
                    <tr>
                        <td><code>AADHAR_BACK_IMAGE</code></td>
                        <td>Aadhaar Back OCR</td>
                        <td>aadharAddress1, aadharAddress2, aadharPin, aadharCity, aadharDist, aadharState</td>
                    </tr>
                    <tr>
                        <td><code>GSTIN_IMAGE</code></td>
                        <td>GSTIN OCR</td>
                        <td>regNumber, legalName, tradeName, business, doi, address1, address2, pin, state, city</td>
                    </tr>
                    <tr>
                        <td><code>PASSPORT_IMAGE</code></td>
                        <td>Passport Front OCR</td>
                        <td>passportNumber, name, nationality, dob, placeOfBirth, dateOfIssue, dateOfExpiry</td>
                    </tr>
                    <tr>
                        <td><code>CHEQUEE</code></td>
                        <td>Cheque OCR</td>
                        <td>accountNumber, ifscCode, bankName, branchName</td>
                    </tr>
                    <tr>
                        <td><code>DRIVING_LICENCE_IMAGE</code></td>
                        <td>Driving License OCR</td>
                        <td>dlNumber, name, dob, address, validUntil</td>
                    </tr>
                    <tr>
                        <td><code>BUSINESS_CARD</code></td>
                        <td>Business Card OCR</td>
                        <td>contactName, firstName, lastName, companyNames, email, phone</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 6: Source Field Detection -->
        <section id="source-detection" class="section">
            <h2><span class="badge">SECTION 6</span> Source Field Detection (Deterministic-First)</h2>

            <p>The <strong>source field</strong> is the field whose value is checked in a condition or provides input data.</p>

            <h3>Source Detection Patterns for Expression Rules</h3>

            <div class="card highlight-blue">
                <h4>Pattern 1: "if {field} is {value}"</h4>
                <div class="pattern-box">
                    <h5>Regex: if\s+["\']?(.+?)["\']?\s+(?:is|equals|==)\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"Make visible if <strong>GST Option</strong> is <strong>Yes</strong>"</div>
                    <div class="extracted">
                        <span class="src">Source: GST Option</span>
                        <span class="cond">Condition: == 'Yes'</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 2: "based on {field}"</h4>
                <div class="pattern-box">
                    <h5>Regex: based\s+on\s+(?:the\s+)?["\']?(.+?)["\']?(?:\s+selection|\s+value)?</h5>
                    <div class="example">"Dropdown values will come based on <strong>Account Group</strong> selection"</div>
                    <div class="extracted">
                        <span class="src">Source: Account Group</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 3: "when {field} is selected/chosen"</h4>
                <div class="pattern-box">
                    <h5>Regex: when\s+["\']?(.+?)["\']?\s+is\s+(?:selected|chosen|picked)</h5>
                    <div class="example">"Visible when <strong>Country</strong> is selected as India"</div>
                    <div class="extracted">
                        <span class="src">Source: Country</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 4: "field {field} value is"</h4>
                <div class="pattern-box">
                    <h5>Regex: field\s+["\']?(.+?)["\']?\s+(?:value\s+)?is\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"If the field <strong>Do you wish to add additional mobile numbers</strong> value is <strong>Yes</strong>"</div>
                    <div class="extracted">
                        <span class="src">Source: Do you wish to add additional mobile numbers</span>
                        <span class="cond">Condition: == 'Yes'</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 5: "copy from {field}" / "data from {field}"</h4>
                <div class="pattern-box">
                    <h5>Regex: (?:copy|data|value)\s+(?:from|will come from)\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"Data will come from <strong>GSTIN verification</strong>"</div>
                    <div class="extracted">
                        <span class="src">Source: GSTIN field</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 6: "Get {data} from {rule}"</h4>
                <div class="pattern-box">
                    <h5>Regex: get\s+(\w+)\s+from\s+(\w+)\s+(?:ocr|validation)</h5>
                    <div class="example">"Get GSTIN from <strong>OCR rule</strong>"</div>
                    <div class="extracted">
                        <span class="src">Source: GSTIN Image upload field (inferred)</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-blue">
                <h4>Pattern 7: "Apply {rule} on {field}"</h4>
                <div class="pattern-box">
                    <h5>Regex: apply\s+(?:the\s+)?(\w+)\s+(?:ocr|validation|rule)\s+(?:on|to)\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"Apply <strong>PAN OCR</strong> on <strong>PAN Card Image</strong>"</div>
                    <div class="extracted">
                        <span class="src">Source: PAN Card Image</span>
                    </div>
                </div>
            </div>

            <h3>Source Detection for Standard Rules</h3>
            <div class="grid-2">
                <div class="card highlight-green">
                    <h4>Document Type to Upload Field Mapping</h4>
                    <table class="data-table">
                        <tr><td><code>PAN</code></td><td>"pan card", "pan image", "pan upload"</td></tr>
                        <tr><td><code>Aadhaar</code></td><td>"aadhaar", "aadhar", "aadhaar front"</td></tr>
                        <tr><td><code>Aadhaar Back</code></td><td>"aadhaar back", "aadhar back"</td></tr>
                        <tr><td><code>GST</code></td><td>"gst certificate", "gstin", "gst image"</td></tr>
                        <tr><td><code>Passport</code></td><td>"passport", "passport front"</td></tr>
                        <tr><td><code>Cheque</code></td><td>"cheque", "cancelled cheque"</td></tr>
                        <tr><td><code>DL</code></td><td>"driving", "licence", "dl"</td></tr>
                    </table>
                </div>
                <div class="card highlight-purple">
                    <h4>Context-Based Source Finding</h4>
                    <ul>
                        <li><strong>Same Section:</strong> Find FILE type fields in same section</li>
                        <li><strong>Keyword Match:</strong> Match document keywords in field name</li>
                        <li><strong>Ordinal Position:</strong> Source typically appears before destination in document</li>
                        <li><strong>Rule Schema:</strong> Use <code>sourceFields</code> from Rule-Schemas.json</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Section 7: Destination Field Detection -->
        <section id="destination-detection" class="section">
            <h2><span class="badge">SECTION 7</span> Destination Field Detection (Deterministic-First)</h2>

            <p>The <strong>destination field</strong> is the field that is affected by the rule (shown/hidden/enabled/disabled/populated).</p>

            <h3>Destination Detection Patterns</h3>

            <div class="card highlight-green">
                <h4>Rule 1: Current Field is Default Destination</h4>
                <div class="pattern-box">
                    <h5>Logic: If no explicit destination, destination = current field being processed</h5>
                    <div class="example">Field: <strong>GSTIN</strong><br>Logic: "Make visible if GST Option is Yes"</div>
                    <div class="extracted">
                        <span class="dest">Destination: GSTIN (current field)</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-green">
                <h4>Pattern 2: "make {field} visible/mandatory"</h4>
                <div class="pattern-box">
                    <h5>Regex: make\s+["\']?(.+?)["\']?\s+(?:visible|invisible|mandatory)</h5>
                    <div class="example">"Make <strong>Additional Mobile Number 1</strong> visible"</div>
                    <div class="extracted">
                        <span class="dest">Destination: Additional Mobile Number 1</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-green">
                <h4>Pattern 3: "then {field} should be"</h4>
                <div class="pattern-box">
                    <h5>Regex: then\s+["\']?(.+?)["\']?\s+should\s+be</h5>
                    <div class="example">"If Yes, then <strong>GST Certificate</strong> should be mandatory"</div>
                    <div class="extracted">
                        <span class="dest">Destination: GST Certificate</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-green">
                <h4>Pattern 4: "copy to {field}" / "store in {field}"</h4>
                <div class="pattern-box">
                    <h5>Regex: (?:copy\s+to|populate|fill|store\s+in)\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"Copy to <strong>Address Details</strong> panel"</div>
                    <div class="extracted">
                        <span class="dest">Destination: Address Details panel fields</span>
                    </div>
                </div>
            </div>

            <div class="card highlight-green">
                <h4>Pattern 5: Multiple destinations with "and"</h4>
                <div class="pattern-box">
                    <h5>Regex: (?:visible|mandatory).*?["\']?(.+?)["\']?\s+and\s+["\']?(.+?)["\']?</h5>
                    <div class="example">"Make visible <strong>GSTIN</strong> and <strong>GST Address</strong>"</div>
                    <div class="extracted">
                        <span class="dest">Destination: GSTIN</span>
                        <span class="dest">Destination: GST Address</span>
                    </div>
                </div>
            </div>

            <h3>Destination Detection for Standard Rules</h3>

            <div class="callout info">
                <h4>ðŸ’¡ Key Insight: Rule-Schemas.json Contains Destination Fields</h4>
                <p>Each predefined rule already specifies its <code>destinationFields</code>. The task is mapping schema field names to actual document field names.</p>
            </div>

            <div class="card highlight-purple">
                <h4>Schema Field to Document Field Mapping</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Schema Field</th>
                            <th>Possible Document Field Names</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><code>panNo</code></td><td>"PAN Number", "PAN", "PAN No"</td></tr>
                        <tr><td><code>name</code></td><td>"Name", "Full Name", "Name as per PAN"</td></tr>
                        <tr><td><code>fatherName</code></td><td>"Father's Name", "Father Name"</td></tr>
                        <tr><td><code>dob</code></td><td>"Date of Birth", "DOB", "Birth Date"</td></tr>
                        <tr><td><code>regNumber</code></td><td>"GSTIN", "GST Number", "Registration Number"</td></tr>
                        <tr><td><code>legalName</code></td><td>"Legal Name", "Legal Name as per GST"</td></tr>
                        <tr><td><code>tradeName</code></td><td>"Trade Name", "Business Name"</td></tr>
                        <tr><td><code>address1</code></td><td>"Address Line 1", "Address 1", "Street"</td></tr>
                        <tr><td><code>pin</code></td><td>"PIN Code", "Pincode", "PIN"</td></tr>
                        <tr><td><code>state</code></td><td>"State", "State Name"</td></tr>
                        <tr><td><code>city</code></td><td>"City", "City Name"</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 8: 6-Step Processing Pipeline -->
        <section id="pipeline" class="section">
            <h2><span class="badge">SECTION 8</span> 6-Step Processing Pipeline</h2>

            <div class="pipeline">
                <div class="pipeline-stage stage-1">
                    <h4><span class="stage-number">1</span> Pre-Processing</h4>
                    <ul>
                        <li>Parse document with DocumentParser</li>
                        <li>Extract all fields with logic/rules text</li>
                        <li>Build field registry (displayName â†’ variableName)</li>
                        <li>Generate variable names if missing</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-green">Cost: $0 (No LLM)</span></p>
                </div>

                <div class="pipeline-stage stage-2">
                    <h4><span class="stage-number">2</span> Level 1 Classification</h4>
                    <ul>
                        <li>Pattern-based rule type detection</li>
                        <li>Keywords: visible/mandatory â†’ Expression</li>
                        <li>Keywords: OCR/validation â†’ Standard</li>
                        <li>Check for conditional logic (if/when/based on)</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-green">Cost: $0 (Pattern Matching)</span></p>
                </div>

                <div class="pipeline-stage stage-3">
                    <h4><span class="stage-number">3</span> Level 2-3 Classification</h4>
                    <ul>
                        <li>For Standard Rules: Identify action type (OCR, VERIFY, etc.)</li>
                        <li>For Standard Rules: Identify source type (PAN_IMAGE, etc.)</li>
                        <li>Narrow search space from 182 â†’ 1-5 rules</li>
                        <li>LLM fallback only if pattern matching fails</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-green">Cost: $0 (mostly)</span></p>
                </div>

                <div class="pipeline-stage stage-4">
                    <h4><span class="stage-number">4</span> Intent Extraction</h4>
                    <ul>
                        <li>Check pattern cache for similar rules</li>
                        <li>If cached â†’ use template (No LLM)</li>
                        <li>If new â†’ call GPT-4o-mini with grounded prompt</li>
                        <li>Extract structured intent (display names only)</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-orange">Cost: ~$0.0001/rule</span></p>
                </div>

                <div class="pipeline-stage stage-5">
                    <h4><span class="stage-number">5</span> Resolution</h4>
                    <ul>
                        <li>Resolve display names â†’ variable names</li>
                        <li>Validate against field registry</li>
                        <li>Match standard rules from Rule-Schemas.json</li>
                        <li>Handle fuzzy matching for field names</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-green">Cost: $0 (No LLM)</span></p>
                </div>

                <div class="pipeline-stage stage-6">
                    <h4><span class="stage-number">6</span> Assembly & Validation</h4>
                    <ul>
                        <li>Validate function names against whitelist</li>
                        <li>Build expr-eval compliant expression</li>
                        <li>Validate syntax correctness</li>
                        <li>Generate final JSON output</li>
                    </ul>
                    <p style="margin-top: 15px;"><span class="badge badge-green">Cost: $0 (No LLM)</span></p>
                </div>
            </div>

            <h3>Complete Processing Algorithm</h3>
            <div class="algorithm-box">
                <h4>def process_field_rules(field: FieldDefinition, registry: Dict, all_fields: List) -> List[Rule]:</h4>
                <div class="algorithm-line"><span class="comment"># Step 1: Pre-processing</span></div>
                <div class="algorithm-line">logic = field.logic</div>
                <div class="algorithm-line"><span class="keyword">if not</span> logic <span class="keyword">or</span> logic.strip() == <span class="string">""</span>:</div>
                <div class="algorithm-line indent-1"><span class="keyword">return</span> []</div>
                <div class="algorithm-line"></div>
                <div class="algorithm-line"><span class="comment"># Step 2: Level 1 Classification (Expression vs Standard)</span></div>
                <div class="algorithm-line">rule_type = classify_rule_type(logic)  <span class="comment"># Pattern-based, No LLM</span></div>
                <div class="algorithm-line"></div>
                <div class="algorithm-line"><span class="keyword">if</span> rule_type == <span class="string">"EXPRESSION"</span>:</div>
                <div class="algorithm-line indent-1"><span class="comment"># Try template matching first (No LLM)</span></div>
                <div class="algorithm-line indent-1">expression = try_template_match(logic, field.name)</div>
                <div class="algorithm-line indent-1"><span class="keyword">if</span> expression:</div>
                <div class="algorithm-line indent-2">sources = extract_sources_deterministic(logic, registry)</div>
                <div class="algorithm-line indent-2">destinations = extract_destinations_deterministic(logic, field, registry)</div>
                <div class="algorithm-line indent-2"><span class="keyword">return</span> [build_expression_rule(expression, sources, destinations, confidence=<span class="number">0.95</span>)]</div>
                <div class="algorithm-line indent-1"></div>
                <div class="algorithm-line indent-1"><span class="comment"># Use grounded LLM for complex cases</span></div>
                <div class="algorithm-line indent-1"><span class="keyword">return</span> extract_expression_with_llm(logic, field, registry)</div>
                <div class="algorithm-line"></div>
                <div class="algorithm-line"><span class="keyword">elif</span> rule_type == <span class="string">"STANDARD"</span>:</div>
                <div class="algorithm-line indent-1"><span class="comment"># Step 3: Level 2 - Action Type Classification</span></div>
                <div class="algorithm-line indent-1">action = classify_action_type(logic)  <span class="comment"># Pattern-based</span></div>
                <div class="algorithm-line indent-1"></div>
                <div class="algorithm-line indent-1"><span class="comment"># Step 3: Level 3 - Source Type Classification</span></div>
                <div class="algorithm-line indent-1">source_type = detect_source_type(logic, action)  <span class="comment"># Pattern-based</span></div>
                <div class="algorithm-line indent-1"></div>
                <div class="algorithm-line indent-1"><span class="comment"># Step 4: Final Rule Matching (narrowed search space)</span></div>
                <div class="algorithm-line indent-1">matched_rule, confidence = match_final_rule(logic, action, source_type)</div>
                <div class="algorithm-line indent-1"></div>
                <div class="algorithm-line indent-1"><span class="comment"># Step 5: Source/Destination Resolution</span></div>
                <div class="algorithm-line indent-1">source_field = find_source_field(logic, matched_rule, all_fields, registry)</div>
                <div class="algorithm-line indent-1">dest_fields = map_schema_destinations(matched_rule, registry)</div>
                <div class="algorithm-line indent-1"></div>
                <div class="algorithm-line indent-1"><span class="comment"># Step 6: Build and validate rule</span></div>
                <div class="algorithm-line indent-1"><span class="keyword">return</span> [build_standard_rule(matched_rule, source_field, dest_fields, confidence)]</div>
            </div>
        </section>

        <!-- Section 9: Anti-Hallucination Strategies -->
        <section id="anti-hallucination" class="section">
            <h2><span class="badge">SECTION 9</span> Anti-Hallucination Strategies</h2>

            <div class="grid-3">
                <div class="card highlight-cyan">
                    <h4>ðŸŽ¯ Grounded Field Registry</h4>
                    <p>LLM receives ONLY actual field names from the document. System prompt includes complete list of available fields, preventing invention of non-existent fields.</p>
                </div>

                <div class="card highlight-purple">
                    <h4>ðŸ”’ Function Whitelist</h4>
                    <p>Only allowed functions (mvi, mm, dis, etc.) are accepted. Any unrecognized function triggers validation error, not silent acceptance.</p>
                </div>

                <div class="card highlight-orange">
                    <h4>ðŸ“ Intent-Only Extraction</h4>
                    <p>LLM extracts ONLY structured intent (function, condition, args) using display names. Variable name resolution happens deterministically post-LLM.</p>
                </div>

                <div class="card highlight-green">
                    <h4>âœ… Post-LLM Validation</h4>
                    <p>Every field reference is validated against the registry. Unknown fields are flagged for human review rather than silently included.</p>
                </div>

                <div class="card highlight-blue">
                    <h4>ðŸŒ¡ï¸ Low Temperature (0.0-0.1)</h4>
                    <p>LLM temperature set to minimum for deterministic outputs. Reduces creative/hallucinatory responses in favor of strict rule following.</p>
                </div>

                <div class="card highlight-pink">
                    <h4>ðŸ“‹ Constrained Selection</h4>
                    <p>For rule matching, present ONLY candidate rules as numbered options. This is a simple multiple-choice question, not open-ended generation.</p>
                </div>
            </div>

            <h3>Grounded LLM System Prompt</h3>
            <div class="code-block">
SYSTEM_PROMPT = <span class="string">"""
You are a rule extraction engine. Convert English logic to structured JSON.

AVAILABLE FIELDS (use ONLY these exact names):
- "Company Name"
- "GSTIN"
- "Please select GST option"
- "Additional Mobile Number 1"
- "Do you wish to add additional mobile numbers (India)?"
... (full list from field registry)

ALLOWED FUNCTIONS:
- mvi(condition, ...fields) - Make visible
- minvi(condition, ...fields) - Make invisible
- mm(condition, ...fields) - Make mandatory
- mnm(condition, ...fields) - Make non-mandatory
- en(condition, ...fields) - Enable
- dis(condition, ...fields) - Disable
- ctfd(condition, source, ...fields) - Copy to fill data
- cf(condition, ...fields) - Clear field

RULES:
1. Use ONLY field names from the list above
2. Use ONLY functions from the list above
3. Output JSON with "statements" array
4. If a field name doesn't match exactly, find the closest match
5. If no match possible, return empty array

Output JSON only, no explanation.
"""</span>
            </div>
        </section>

        <!-- Section 10: Cost Optimization -->
        <section id="cost-optimization" class="section">
            <h2><span class="badge">SECTION 10</span> Cost Optimization</h2>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Description</th>
                        <th>Savings</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pattern Caching</strong></td>
                        <td>Cache common rule patterns (e.g., "visible if X is Yes"). Re-use without LLM call.</td>
                        <td><span class="badge badge-green">~40% reduction</span></td>
                    </tr>
                    <tr>
                        <td><strong>Template Matching</strong></td>
                        <td>Pre-define templates for common patterns. Only variable parts need extraction.</td>
                        <td><span class="badge badge-green">~30% reduction</span></td>
                    </tr>
                    <tr>
                        <td><strong>Hierarchical Classification</strong></td>
                        <td>Narrow search space before LLM call. 182 â†’ 1-5 rules.</td>
                        <td><span class="badge badge-green">~95% fewer tokens</span></td>
                    </tr>
                    <tr>
                        <td><strong>GPT-4o-mini Model</strong></td>
                        <td>Use smaller model for classification and simple extraction. ~15x cheaper than GPT-4.</td>
                        <td><span class="badge badge-green">~90% per call</span></td>
                    </tr>
                    <tr>
                        <td><strong>Regex Pre-filtering</strong></td>
                        <td>Skip LLM for empty logic or simple disable-only rules. Handle with regex.</td>
                        <td><span class="badge badge-green">~15% reduction</span></td>
                    </tr>
                    <tr>
                        <td><strong>Batch Processing</strong></td>
                        <td>Group similar rules into single LLM call. Reduces API overhead.</td>
                        <td><span class="badge badge-orange">~20% reduction</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Cost Comparison (388 Fields Document)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Approach</th>
                        <th>LLM Calls</th>
                        <th>Est. Cost</th>
                        <th>Hallucination Risk</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Naive (LLM for every field)</td>
                        <td>388</td>
                        <td>~$0.50</td>
                        <td><span class="badge badge-red">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>Basic Optimization (gpt-4o-mini)</td>
                        <td>388</td>
                        <td>~$0.15</td>
                        <td><span class="badge badge-orange">MEDIUM</span></td>
                    </tr>
                    <tr>
                        <td>Template + Classification</td>
                        <td>~60</td>
                        <td>~$0.05</td>
                        <td><span class="badge badge-orange">MEDIUM-LOW</span></td>
                    </tr>
                    <tr style="background: rgba(34,197,94,0.1);">
                        <td><strong>Hierarchical + Grounded (This Architecture)</strong></td>
                        <td><strong>~40</strong></td>
                        <td><strong>~$0.03</strong></td>
                        <td><span class="badge badge-green">LOW</span></td>
                    </tr>
                </tbody>
            </table>

            <div class="callout success">
                <h4>âœ… 94% Cost Reduction</h4>
                <p>From $0.50 to $0.03 per document by combining hierarchical classification, pattern caching, and grounded prompts.</p>
            </div>
        </section>

        <!-- Section 11: Output JSON Schema -->
        <section id="output-schema" class="section">
            <h2><span class="badge">SECTION 11</span> Output JSON Schema</h2>

            <div class="json-output">
                <pre>{
  <span class="string">"document_name"</span>: <span class="string">"Vendor Creation Sample BUD"</span>,
  <span class="string">"total_fields"</span>: <span class="number">388</span>,
  <span class="string">"fields_with_rules"</span>: <span class="number">245</span>,
  <span class="string">"total_rules_extracted"</span>: <span class="number">412</span>,
  <span class="string">"extraction_stats"</span>: {
    <span class="string">"expression_rules"</span>: <span class="number">380</span>,
    <span class="string">"standard_rules"</span>: <span class="number">32</span>,
    <span class="string">"deterministic_extractions"</span>: <span class="number">350</span>,
    <span class="string">"llm_extractions"</span>: <span class="number">62</span>,
    <span class="string">"cache_hits"</span>: <span class="number">156</span>
  },
  <span class="string">"fields"</span>: [
    {
      <span class="string">"field_name"</span>: <span class="string">"Additional Mobile Number 1"</span>,
      <span class="string">"variable_name"</span>: <span class="string">"__add_mobile_1__"</span>,
      <span class="string">"field_type"</span>: <span class="string">"MOBILE"</span>,
      <span class="string">"original_logic"</span>: <span class="string">"Make visible and Mandatory if \"Do you wish to add...\" is Yes"</span>,
      <span class="string">"rules"</span>: [
        {
          <span class="string">"rule_type"</span>: <span class="string">"EXPRESSION"</span>,
          <span class="string">"action"</span>: <span class="string">"EXECUTE"</span>,
          <span class="string">"source_fields"</span>: [
            {
              <span class="string">"display_name"</span>: <span class="string">"Do you wish to add additional mobile numbers (India)?"</span>,
              <span class="string">"variable_name"</span>: <span class="string">"__add_mobile_india__"</span>,
              <span class="string">"detection_method"</span>: <span class="string">"DETERMINISTIC"</span>,
              <span class="string">"pattern_matched"</span>: <span class="string">"field_value_is"</span>
            }
          ],
          <span class="string">"destination_fields"</span>: [
            {
              <span class="string">"display_name"</span>: <span class="string">"Additional Mobile Number 1"</span>,
              <span class="string">"variable_name"</span>: <span class="string">"__add_mobile_1__"</span>,
              <span class="string">"detection_method"</span>: <span class="string">"DETERMINISTIC"</span>,
              <span class="string">"pattern_matched"</span>: <span class="string">"current_field_default"</span>
            }
          ],
          <span class="string">"conditions"</span>: [
            {
              <span class="string">"source_variable"</span>: <span class="string">"__add_mobile_india__"</span>,
              <span class="string">"operator"</span>: <span class="string">"=="</span>,
              <span class="string">"value"</span>: <span class="string">"Yes"</span>
            }
          ],
          <span class="string">"expression"</span>: <span class="string">"mvi(vo(\"__add_mobile_india__\")=='Yes',\"__add_mobile_1__\");mm(vo(\"__add_mobile_india__\")=='Yes',\"__add_mobile_1__\");minvi(vo(\"__add_mobile_india__\")!='Yes',\"__add_mobile_1__\");mnm(vo(\"__add_mobile_india__\")!='Yes',\"__add_mobile_1__\");"</span>,
          <span class="string">"confidence"</span>: <span class="number">0.95</span>
        }
      ]
    },
    {
      <span class="string">"field_name"</span>: <span class="string">"GSTIN"</span>,
      <span class="string">"variable_name"</span>: <span class="string">"__gstin__"</span>,
      <span class="string">"field_type"</span>: <span class="string">"TEXT"</span>,
      <span class="string">"original_logic"</span>: <span class="string">"Get GSTIN from OCR rule. Perform GSTIN validation..."</span>,
      <span class="string">"rules"</span>: [
        {
          <span class="string">"rule_type"</span>: <span class="string">"STANDARD"</span>,
          <span class="string">"action"</span>: <span class="string">"OCR"</span>,
          <span class="string">"rule_schema_id"</span>: <span class="number">347</span>,
          <span class="string">"rule_schema_name"</span>: <span class="string">"GSTIN OCR"</span>,
          <span class="string">"source_fields"</span>: [
            {
              <span class="string">"display_name"</span>: <span class="string">"Upload GST Certificate"</span>,
              <span class="string">"variable_name"</span>: <span class="string">"__gst_certificate__"</span>,
              <span class="string">"detection_method"</span>: <span class="string">"DETERMINISTIC"</span>,
              <span class="string">"pattern_matched"</span>: <span class="string">"section_context_file_field"</span>
            }
          ],
          <span class="string">"destination_fields"</span>: [
            {
              <span class="string">"schema_field"</span>: <span class="string">"regNumber"</span>,
              <span class="string">"display_name"</span>: <span class="string">"GSTIN"</span>,
              <span class="string">"variable_name"</span>: <span class="string">"__gstin__"</span>,
              <span class="string">"detection_method"</span>: <span class="string">"SCHEMA_MAPPING"</span>
            },
            {
              <span class="string">"schema_field"</span>: <span class="string">"legalName"</span>,
              <span class="string">"display_name"</span>: <span class="string">"Legal Name as per GST"</span>,
              <span class="string">"variable_name"</span>: <span class="string">"__legal_name_gst__"</span>,
              <span class="string">"detection_method"</span>: <span class="string">"SCHEMA_MAPPING"</span>
            }
          ],
          <span class="string">"confidence"</span>: <span class="number">0.90</span>
        }
      ]
    }
  ]
}</pre>
            </div>
        </section>

        <!-- Section 12: Implementation Modules -->
        <section id="implementation" class="section">
            <h2><span class="badge">SECTION 12</span> Implementation Modules</h2>

            <div class="grid-3">
                <div class="card highlight-green">
                    <h4>ðŸ“‹ field_registry.py</h4>
                    <ul>
                        <li><code>build_registry(fields)</code></li>
                        <li><code>normalize_field_name(name)</code></li>
                        <li><code>resolve_to_variable(display_name)</code></li>
                        <li><code>fuzzy_match_field(query)</code></li>
                        <li><code>generate_variable_name(field)</code></li>
                    </ul>
                </div>

                <div class="card highlight-blue">
                    <h4>ðŸ” rule_classifier.py</h4>
                    <ul>
                        <li><code>classify_rule_type(logic)</code></li>
                        <li><code>classify_action_type(logic)</code></li>
                        <li><code>detect_source_type(logic, action)</code></li>
                        <li><code>has_conditional_logic(logic)</code></li>
                        <li><code>get_classification_keywords()</code></li>
                    </ul>
                </div>

                <div class="card highlight-cyan">
                    <h4>ðŸ“¥ source_detector.py</h4>
                    <ul>
                        <li><code>extract_source_patterns(logic)</code></li>
                        <li><code>find_source_in_context(field, all_fields)</code></li>
                        <li><code>map_document_type_to_field(doc_type)</code></li>
                        <li><code>llm_identify_source(logic)</code></li>
                    </ul>
                </div>

                <div class="card highlight-green">
                    <h4>ðŸ“¤ destination_detector.py</h4>
                    <ul>
                        <li><code>extract_destination_patterns(logic)</code></li>
                        <li><code>map_schema_to_document(schema_fields)</code></li>
                        <li><code>resolve_panel_fields(panel_name)</code></li>
                        <li><code>llm_identify_destinations(logic)</code></li>
                    </ul>
                </div>

                <div class="card highlight-purple">
                    <h4>ðŸ“‹ pattern_registry.py</h4>
                    <ul>
                        <li><code>SOURCE_PATTERNS</code> dict</li>
                        <li><code>DESTINATION_PATTERNS</code> dict</li>
                        <li><code>EXPRESSION_TEMPLATES</code> dict</li>
                        <li><code>DOCUMENT_TYPE_MAPPING</code> dict</li>
                        <li><code>ACTION_KEYWORDS</code> dict</li>
                    </ul>
                </div>

                <div class="card highlight-orange">
                    <h4>ðŸ§  grounded_llm.py</h4>
                    <ul>
                        <li><code>build_grounded_prompt(registry)</code></li>
                        <li><code>extract_intent_with_llm(logic)</code></li>
                        <li><code>select_rule_with_llm(candidates)</code></li>
                        <li><code>validate_llm_response(response)</code></li>
                    </ul>
                </div>

                <div class="card highlight-cyan">
                    <h4>ðŸ’¾ pattern_cache.py</h4>
                    <ul>
                        <li><code>try_template_match(logic)</code></li>
                        <li><code>cache_pattern(logic, result)</code></li>
                        <li><code>get_cached_pattern(logic)</code></li>
                        <li><code>compute_pattern_hash(logic)</code></li>
                    </ul>
                </div>

                <div class="card highlight-blue">
                    <h4>ðŸ”§ rule_matcher.py</h4>
                    <ul>
                        <li><code>get_rules_by_action(action)</code></li>
                        <li><code>get_rules_by_source(source_type)</code></li>
                        <li><code>match_final_rule(logic, candidates)</code></li>
                        <li><code>keyword_similarity(logic, rule)</code></li>
                    </ul>
                </div>

                <div class="card highlight-green">
                    <h4>ðŸ”¨ expression_assembler.py</h4>
                    <ul>
                        <li><code>build_expression(intent)</code></li>
                        <li><code>validate_function_name(func)</code></li>
                        <li><code>format_condition(condition)</code></li>
                        <li><code>combine_statements(statements)</code></li>
                    </ul>
                </div>

                <div class="card highlight-red">
                    <h4>âœ… validator.py</h4>
                    <ul>
                        <li><code>validate_source_exists(source)</code></li>
                        <li><code>validate_destinations_exist(dests)</code></li>
                        <li><code>validate_expression_syntax(expr)</code></li>
                        <li><code>calculate_confidence(result)</code></li>
                        <li><code>flag_for_review(rule)</code></li>
                    </ul>
                </div>

                <div class="card highlight-purple">
                    <h4>ðŸŽ¯ rules_orchestrator.py</h4>
                    <ul>
                        <li><code>process_document(doc_path)</code></li>
                        <li><code>process_field_rules(field)</code></li>
                        <li><code>export_to_json(results)</code></li>
                        <li><code>generate_report(stats)</code></li>
                    </ul>
                </div>

                <div class="card highlight-pink">
                    <h4>ðŸ“Š schema_loader.py</h4>
                    <ul>
                        <li><code>load_rule_schemas(path)</code></li>
                        <li><code>index_by_action(rules)</code></li>
                        <li><code>index_by_source(rules)</code></li>
                        <li><code>get_destination_fields(rule)</code></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p><strong>Document Parser - Complete Rules Engine Architecture v3.0</strong></p>
            <p>Deterministic-First Approach | Hierarchical Classification | Source & Destination Identification</p>
            <p style="margin-top: 15px; font-size: 0.85em;">
                Files: RULES_ENGINE_ARCHITECTURE.html | RULES_REFERENCE.md
            </p>
        </footer>
    </div>
</body>
</html>
